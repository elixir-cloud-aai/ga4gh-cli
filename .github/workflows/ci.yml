name: GitHub CI/CD Workflow	

on: [push, pull_request]	

jobs:	
  build:	

    runs-on: ubuntu-latest	
    container:	
      image: ubuntu:24.04	
    env:	
      OPENSSL_DIR: /usr/include/openssl	
      OPENSSL_LIB_DIR: /usr/lib/x86_64-linux-gnu	
      OPENSSL_INCLUDE_DIR: /usr/include/openssl	

    steps:	
    - name: Install Rust	
      run: |	
        apt-get update	
        apt-get install -y curl git build-essential libssl-dev 	
        # if ! command -v rustup &> /dev/null # might not be installed while executing using `act`	
        # then	
        #     curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y	
        #     . $HOME/.cargo/env	
        # fi	
        rustup update stable	

    - name: Install Node.js # required for build-models.sh
      run: |
        curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
        apt-get install -y nodejs

    - name: Set up JDK 11 # required for build-models.sh	
      uses: actions/setup-java@v3
      with:	
        distribution: 'adopt'	
        java-version: '11'	

    - name: Install Go	
      uses: actions/setup-go@v4
      with:	
        go-version: '^1.22'  	
    - name: Install Funnel	
      run: |	
          if [ -d "funnel" ]; then rm -Rf funnel; fi	
          git clone https://github.com/ohsu-comp-bio/funnel.git	
          cd funnel && make && make install && cd ..	
    - uses: actions/checkout@v4 # checkout the repository	
    - name: Build models	
      run: |	
        # . $HOME/.cargo/env	
        bash ./build-models.sh	
    - name: Build	
      run: |	
        # . $HOME/.cargo/env	
        cargo build --verbose	
    - name: Run tests	
      run: |	
        # . $HOME/.cargo/env	
        bash ./run-tests.sh	
    - name: Lint	
      run: |	
        # . $HOME/.cargo/env	
        cargo clippy -- -D warnings	
    - name: Format	
      run: |	
        # . $HOME/.cargo/env	
        cargo fmt -- ./lib/src/serviceinfo/models/*.rs # workaround to fix autogenerated code formatting	
        cargo fmt -- ./lib/src/tes/models/*.rs	
        cargo fmt -- --check